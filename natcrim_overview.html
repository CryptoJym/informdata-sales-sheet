<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NatCrim Overview — Coverage + Sources</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles/tokens.css" />
</head>
<body class="page-product">
  <div data-include="components/header.html"></div>
  <main class="page" id="main-content">
    <section class="card">
      <h1>NatCrim Overview</h1>
      <p class="lead">Single view of the national scan: totals, domain breakdown, fulfillment method, and a searchable source directory — all powered by the same canonical CSVs.</p>
      <div class="stat-grid" id="stats"></div>
    </section>

    <section class="card">
      <h2>Coverage domains</h2>
      <div class="filters" id="domainFilters"></div>
      <div class="table-responsive">
      <table>
        <caption>Top States by Coverage Domain and Record Count</caption> <caption>National Criminal Database Summary Statistics</caption><thead><tr><th>State</th><th>Domain</th><th>Sources</th><th>Total records</th></tr></thead>
        <tbody id="domainTable"></tbody>
      </table>
      </div>
    </section>

    <section class="card">
      <h2>Fulfillment method</h2>
      <p class="lead">Every state is fulfilled by InformData — either a statewide repository covers county requirements, or county workflows do.</p>
      <div class="stat-grid" id="fulfillment"></div>
    </section>

    <section class="card">
      <h2>Source directory</h2>
      <div class="filters" id="recordFilters"></div>
      <div class="table-responsive">
      <table>
        <thead><tr><th>State</th><th>Record type</th><th>Source</th><th>Scope</th><th>Level</th><th>Last refresh</th><th>Records</th></tr></thead>
        <tbody id="sourceTable"></tbody>
      </table>
      </div>
    </section>
  </main>

    <script>
      function parseCSV(text){
        const lines = text.trim().split(/\r?\n/); if(!lines.length) return [];
        const headers = lines.shift().split(',');
        return lines.map(line=>{
          const vals=[], out={}; let cur='',q=false; for(const ch of line){ if(ch==='"'){ q=!q;} else if(ch===',' && !q){ vals.push(cur); cur=''; } else { cur+=ch; } } vals.push(cur);
          headers.forEach((h,i)=> out[h] = (vals[i]??'').replace(/^"|"$/g,''));
          return out;
        });
      }
      const fmt = n => Number(n||0).toLocaleString();
      const asDate = d => d ? new Date(d) : null;

      async function loadAll(){
        const [sourcesText, stateTotalsText, scopeText, statewideText] = await Promise.all([
          fetch('content/pricing/natcrim_sources_2025-10-03.csv').then(r=>r.text()),
          fetch('content/pricing/natcrim_state_totals_2025-10-03.csv').then(r=>r.text()),
          fetch('content/pricing/natcrim_scope_summary_2025-10-03.csv').then(r=>r.text()),
          fetch('content/pricing/informdata_statewide_coverage.csv').then(r=>r.text()),
        ]);
        const sources = parseCSV(sourcesText).map(r=>({
          code:r.standardized_state, state:r.state_name, type:r.record_type, name:r.source_name,
          scope:r.coverage_scope, level:r.court_level, date:r.refresh_date, count:+r.record_count||0
        }));
        const stateTotals = parseCSV(stateTotalsText).map(r=>({code:r.standardized_state, state:r.state_name, count:+r.record_count||0}));
        const scope = parseCSV(scopeText);
        const statewide = parseCSV(statewideText);

        // Stats
        const overall = stateTotals.reduce((s,r)=>s+r.count,0);
        const statsEl = document.getElementById('stats');
        statsEl.innerHTML = `
          <div class="stat-card"><strong>${(overall/1_000_000_000).toFixed(2)}B</strong><span>Total records indexed</span></div>
          <div class="stat-card"><strong>${fmt(sources.length)}</strong><span>Individual databases</span></div>
          <div class="stat-card"><strong>${new Set(sources.map(r=>r.code)).size}</strong><span>States & territories</span></div>`;

        // Domains
        const domainFilters = document.getElementById('domainFilters');
        const domainTable = document.getElementById('domainTable');
        const domains = Array.from(new Set(scope.map(r=>r.coverage_domain))).sort();
        let active = domains[0]||null;
        function renderDomainFilters(){
          domainFilters.innerHTML = domains.map(d=>`<button type="button" class="chip ${d===active?'active':''}" data-d="${d}">${d.replace(/_/g,' ')}</button>`).join('');
          domainFilters.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{ active=b.dataset.d; renderDomainFilters(); renderDomainTable(); }));
        }
        function renderDomainTable(){
          const rows = scope.filter(r=>!active||r.coverage_domain===active).sort((a,b)=> (+b.total_records||0) - (+a.total_records||0)).slice(0,20);
          domainTable.innerHTML = rows.map(r=> `<tr><td>${r.state_name}</td><td>${r.coverage_domain.replace(/_/g,' ')}</td><td>${fmt(r.source_count)}</td><td>${fmt(r.total_records)}</td></tr>`).join('');
        }
        renderDomainFilters(); renderDomainTable();

        // Fulfillment card
        const wins = statewide.filter(r=>r.statewide_recommended==='Yes').length;
        const county = statewide.length - wins;
        document.getElementById('fulfillment').innerHTML = `
          <div class="stat-card"><strong>${wins}</strong><span>Statewide wins</span></div>
          <div class="stat-card"><strong>${county}</strong><span>Covered via county workflows</span></div>
          <div class="stat-card"><strong>0</strong><span>Uncovered states</span></div>`;

        // Source directory table
        const recordFilters = document.getElementById('recordFilters');
        const sourceTable = document.getElementById('sourceTable');
        const types = ['ALL', ...Array.from(new Set(sources.map(r=>r.type))).sort()];
        let tActive = 'ALL';
        function renderTypeFilters(){
          recordFilters.innerHTML = types.map(t=>`<button type="button" class="chip ${t===tActive?'active':''}" data-t="${t}">${t}</button>`).join('');
          recordFilters.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=>{ tActive=b.dataset.t; renderTable(); renderTypeFilters(); }));
        }
        function renderTable(){
          const rows = sources.filter(r=> tActive==='ALL' || r.type===tActive).slice(0,500);
          sourceTable.innerHTML = rows.map(r=> `<tr><td>${r.code}</td><td>${r.type}</td><td>${r.name}</td><td>${r.scope}</td><td>${r.level}</td><td>${r.date||''}</td><td>${fmt(r.count)}</td></tr>`).join('');
        }
        renderTypeFilters(); renderTable();
      }
      loadAll();
    </script>
    <div data-include="components/footer.html"></div>
  <script src="components/include.js" defer></script>
  </body>
  </html>
