<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InformData National Source Directory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles/tokens.css" />
  <style>
    .page { max-width: 1320px; margin: 0 auto; padding: 2.5rem 1.5rem 4rem; }
    header.hero { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; }
    header.hero h1 { margin: 0; font-size: 2.5rem; font-weight: 700; }
    header.hero p { margin: 0; color: var(--muted); max-width: 75ch; }
    .summary-grid { display: grid; gap: 0.9rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 2rem; }
    .summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 1.1rem 1.25rem; box-shadow: var(--shadow-lg); }
    .summary-card strong { display: block; font-size: 2rem; font-weight: 700; }
    .summary-card span { color: var(--muted); font-size: var(--fs-sm); }
    .filters { background: rgba(255,255,255,0.9); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 1.1rem 1.3rem; box-shadow: var(--shadow-md); margin-bottom: 1.5rem; display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); align-items: end; }
    label { font-size: var(--fs-xs); font-weight: 600; color: var(--muted); margin-bottom: 0.3rem; display: block; }
    select, input[type='search'] { width: 100%; padding: 0.6rem 0.75rem; border-radius: 0.6rem; border: 1px solid var(--border); background: var(--surface); font-size: 0.95rem; }
    button.action { padding: 0.65rem 1.1rem; border-radius: var(--radius-md); border: none; font-weight: 600; background: var(--accent); color: #fff; cursor: pointer; justify-self: flex-start; box-shadow: 0 8px 16px rgba(37,99,235,0.20); }
    button.action:hover { box-shadow: 0 10px 18px rgba(37,99,235,0.25); }
    table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: var(--radius-xl); overflow: hidden; }
    thead th { background: var(--accent-soft); padding: 0.75rem; text-align: left; font-size: var(--fs-xs); text-transform: uppercase; letter-spacing: 0.04em; border-bottom: 1px solid var(--border); }
    tbody td { padding: 0.7rem; border-bottom: 1px solid var(--border); font-size: 0.95rem; vertical-align: top; }
    tbody tr:nth-child(even) { background: rgba(37,99,235,0.05); }
    .table-wrapper { border: 1px solid var(--border); border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); overflow: hidden; }
    .results-bar { display: flex; justify-content: space-between; align-items: center; margin: 0 0 0.8rem; color: var(--muted); font-size: 0.95rem; }
    .note { margin-top: 0.8rem; color: var(--muted); font-size: var(--fs-sm); }
    @media (max-width: 640px) {
      header.hero h1 { font-size: var(--fs-xl); }
      .filters { grid-template-columns: 1fr; }
      .results-bar { flex-direction: column; gap: 0.5rem; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div data-include="components/header.html"></div>
  <main class="page">
    <header class="hero">
      <h1>InformData National Source Directory</h1>
      <p>Browse every database and repository that feeds InformData’s national criminal search. Filter by state, record type, or keyword to answer detailed coverage questions during customer conversations.</p>
      <!-- Shared nav lives in components/header.html -->
    </header>

    <section class="summary-grid" aria-live="polite">
      <article class="summary-card"><strong id="statUnique">--</strong><span>Distinct databases (unique sources)</span></article>
      <article class="summary-card"><strong id="statListings">--</strong><span>Dataset listings (incl. county rows)</span></article>
      <article class="summary-card"><strong id="statStates">--</strong><span>States & territories</span></article>
      <article class="summary-card"><strong id="statRecords">--</strong><span>Distinct record types</span></article>
    </section>

    <section class="filters" aria-label="Filters">
      <div>
        <label for="stateSelect">State</label>
        <select id="stateSelect"></select>
      </div>
      <div>
        <label for="recordSelect">Record type</label>
        <select id="recordSelect"></select>
      </div>
      <div>
        <label for="searchInput">Search sources & notes</label>
        <input id="searchInput" type="search" placeholder="Search jurisdiction, source, or notes" />
      </div>
      <button id="downloadCsv" class="action" type="button">Download filtered CSV</button>
    </section>

    <div class="results-bar">
      <span id="resultCount">Loading sources…</span>
      <span>Updated from InformData snapshot (October 3, 2025)</span>
    </div>

    <div class="table-wrapper">
      <table aria-describedby="resultCount">
        <thead>
          <tr>
            <th scope="col">State</th>
            <th scope="col">Jurisdiction</th>
            <th scope="col">Source name</th>
            <th scope="col">Record type</th>
            <th scope="col">Updated</th>
            <th scope="col">Coverage notes</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <p class="note">Tip: pair this list with the pricing breakout to explain why national database hits still require county confirmations. Use the download button for bespoke customer documentation.</p>
  </main>

  <script>
    const DATA_URL = 'content/pricing/natcrim_sources_2025-10-03.csv';
    function parseCSV(text){
      const lines=text.trim().split(/\r?\n/); if(!lines.length) return [];
      const headers = lines.shift().split(',');
      return lines.map(line=>{
        const out={}, vals=[]; let cur='', q=false; for(const ch of line){ if(ch==='"'){q=!q;} else if(ch===',' && !q){ vals.push(cur); cur=''; } else { cur+=ch; } } vals.push(cur);
        headers.forEach((h,i)=> out[h]= (vals[i]??'').replace(/^"|"$/g,''));
        return out;
      });
    }
    const stateSelect = document.getElementById('stateSelect');
    const recordSelect = document.getElementById('recordSelect');
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('tableBody');
    const resultCount = document.getElementById('resultCount');
    const downloadCsv = document.getElementById('downloadCsv');
    const statSources = document.getElementById('statSources');
    const statStates = document.getElementById('statStates');
    const statRecords = document.getElementById('statRecords');
    const statRecent = document.getElementById('statRecent');

    let sources = [];
    let filtered = [];

    function uniqueSorted(values) {
      return Array.from(new Set(values.filter(Boolean))).sort((a, b) => a.localeCompare(b));
    }

    function formatDate(value) {
      if (!value) return '—';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '—';
      return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function renderTable(rows) {
      tableBody.innerHTML = '';
      const fragment = document.createDocumentFragment();
      rows.forEach(row => {
        const tr = document.createElement('tr');
        const cells = [row.state, row.jurisdiction || '—', row.source_name, row.record_type, formatDate(row.updated_at), row.coverage_notes || '—'];
        cells.forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          fragment.appendChild(td);
        });
        // Because we appended cells directly, need to assign to tr properly
      });
    }

    function renderRows(rows) {
      tableBody.innerHTML = '';
      const fragment = document.createDocumentFragment();
      rows.forEach(row => {
        const tr = document.createElement('tr');
        const cells = [
          row.state,
          row.jurisdiction || '—',
          row.source_name,
          row.record_type,
          formatDate(row.updated_at),
          row.coverage_notes || '—'
        ];
        cells.forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        });
        fragment.appendChild(tr);
      });
      tableBody.appendChild(fragment);
      resultCount.textContent = `${rows.length.toLocaleString()} sources match filters`;
    }

    function applyFilters() {
      const state = stateSelect.value;
      const record = recordSelect.value;
      const term = searchInput.value.trim().toLowerCase();
      filtered = sources.filter(row => {
        const matchesState = !state || row.state === state;
        const matchesRecord = !record || row.record_type === record;
        const matchesSearch = !term || [row.jurisdiction, row.source_name, row.coverage_notes]
          .filter(Boolean)
          .some(field => field.toLowerCase().includes(term));
        return matchesState && matchesRecord && matchesSearch;
      });
      renderRows(filtered);
    }

    function populateFilters() {
      const states = [''].concat(uniqueSorted(sources.map(row => row.state)));
      const records = [''].concat(uniqueSorted(sources.map(row => row.record_type)));
      stateSelect.innerHTML = states.map(value => `<option value="${value}">${value ? value : 'All states'}</option>`).join('');
      recordSelect.innerHTML = records.map(value => `<option value="${value}">${value ? value : 'All record types'}</option>`).join('');
    }

    // No separate freshness tile; we show unique vs listings consistently with other pages.

    function downloadFilteredCsv() {
      const rows = filtered.length ? filtered : sources;
      const header = ['state', 'jurisdiction', 'source_name', 'record_type', 'updated_at', 'coverage_notes'];
      const csv = [header.join(',')]
        .concat(rows.map(row => header.map(key => {
          const value = row[key] ?? '';
          const escaped = String(value).replace(/"/g, '""');
          return `"${escaped}"`;
        }).join(',')))
        .join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'informdata_natcrim_sources.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    fetch(DATA_URL)
      .then(res => { if(!res.ok) throw new Error('Failed to load source dataset'); return res.text(); })
      .then(text => {
        const rows = parseCSV(text);
        sources = rows.map(r => ({
          state: r.standardized_state,
          jurisdiction: r.coverage_scope || '',
          source_name: r.source_name,
          record_type: r.record_type,
          coverage_notes: r.court_level || '',
          updated_at: r.refresh_date,
        }));
        // Summary counts
        const uniqueDatabases = new Set(sources.map(r => r.source_name)).size;
        document.getElementById('statUnique').textContent = uniqueDatabases.toLocaleString();
        document.getElementById('statListings').textContent = sources.length.toLocaleString();
        document.getElementById('statStates').textContent = uniqueSorted(sources.map(row => row.state)).length.toLocaleString();
        document.getElementById('statRecords').textContent = uniqueSorted(sources.map(row => row.record_type)).length.toLocaleString();
        populateFilters();
        applyFilters();
      })
      .catch(err => {
        console.error(err);
        resultCount.textContent = 'Unable to load sources. Refresh or contact Sales Ops.';
      });

    stateSelect.addEventListener('change', applyFilters);
    recordSelect.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);
    downloadCsv.addEventListener('click', downloadFilteredCsv);
  </script>
  <script src="components/include.js" defer></script>
</body>
</html>
